<?xml version="1.0" encoding="utf-8" ?>
<ContentPage 
    x:Class="Taskplanner.pages.TasksPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewmodels="clr-namespace:Taskplanner.ViewModels"
    xmlns:models="clr-namespace:Taskplanner.Models"
    xmlns:converters="clr-namespace:Taskplanner.Converters"
    Title="Mina Uppgifter">

    <!-- Binda ViewModel -->
    <ContentPage.BindingContext>
        <viewmodels:TasksViewModel />
    </ContentPage.BindingContext>

    <!-- Converters -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:CompletedToColorConverter x:Key="CompletedToColorConverter" />
            <converters:CompletedToIconConverter x:Key="CompletedToIconConverter" />
            <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter" />
            <converters:DateToVisibilityConverter x:Key="DateToVisibilityConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.Content>
        <ScrollView>
            <StackLayout Padding="20" Spacing="15">

                <!-- Header -->
                <StackLayout Spacing="5">
                    <Label Text="Mina Uppgifter" 
                           FontSize="28" 
                           FontAttributes="Bold"
                           HorizontalOptions="Center" />
                    
                    <Label Text="Hantera och organisera dina dagliga uppgifter"
                           FontSize="14"
                           HorizontalOptions="Center" />
                </StackLayout>

                <!-- Adda task -->
                <Frame BackgroundColor="{DynamicResource CardBackgroundColor}"
                       Padding="15"
                       CornerRadius="15"
                       HasShadow="True">
                    <StackLayout Spacing="10">

                        <Label Text="Lägg till ny uppgift" 
                               FontSize="18" 
                               FontAttributes="Bold" />

                        <Entry x:Name="TitleEntry" 
                               Placeholder="Titel på uppgift..." />

                        <Entry x:Name="DescriptionEntry" 
                               Placeholder="Beskrivning (valfritt)..." />

                        <StackLayout Orientation="Horizontal" Spacing="10">
                            <Label Text="Förfallodatum:"
                                   VerticalOptions="Center" />
                            <DatePicker x:Name="DueDatePicker"
                                        HorizontalOptions="FillAndExpand" />
                        </StackLayout>

                        <Button Text="Lägg till uppgift" 
                                Clicked="OnAddTaskClicked"
                                BackgroundColor="{DynamicResource PrimaryColor}"
                                TextColor="White"
                                CornerRadius="10"
                                HeightRequest="50" />

                    </StackLayout>
                </Frame>

                <!-- Task räkna -->
                <Label Text="{Binding Tasks.Count, StringFormat='Antal uppgifter: {0}'}" 
                       FontSize="16" 
                       FontAttributes="Bold" />

                <!-- Task List -->
                <RefreshView IsRefreshing="{Binding IsBusy}"
                             Command="{Binding LoadDataCommand}">
                    <CollectionView ItemsSource="{Binding Tasks}"
                                    Margin="0,10">

                        <!-- visa när den är tom -->
                        <CollectionView.EmptyView>
                            <StackLayout Spacing="10" Padding="20">
                                <Label Text="📄"
                                       FontSize="48"
                                       HorizontalOptions="Center" />

                                <Label Text="Inga uppgifter att visa"
                                       FontSize="16"
                                       HorizontalOptions="Center" />

                                <Label Text="Lägg till en ny uppgift ovan!"
                                       FontSize="14"
                                       HorizontalOptions="Center" />
                            </StackLayout>
                        </CollectionView.EmptyView>

                        <!-- Task Item Template -->
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:TaskModel">

                                <Frame Padding="15"
                                       CornerRadius="12"
                                       HasShadow="True"
                                       BackgroundColor="{DynamicResource CardBackgroundColor}"
                                       Margin="0,5">

                                    <Grid ColumnDefinitions="*,Auto,Auto"
                                          RowDefinitions="Auto,Auto,Auto"
                                          RowSpacing="5">

                                        <!-- Title -->
                                        <Label Grid.Row="0" Grid.Column="0"
                                               Text="{Binding Title}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               TextColor="{Binding IsCompleted, Converter={StaticResource CompletedToColorConverter}}" />

                                        <!-- Toggle Button -->
                                        <Button Grid.Row="0" Grid.Column="1"
                                                Text="{Binding IsCompleted, Converter={StaticResource CompletedToIconConverter}}"
                                                Command="{Binding BindingContext.ToggleCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="Transparent"
                                                WidthRequest="40" HeightRequest="40" />

                                        <!-- Delete Button -->
                                        <Button Grid.Row="0" Grid.Column="2"
                                                Text="🗑️"
                                                Command="{Binding BindingContext.DeleteCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="Transparent"
                                                WidthRequest="40" HeightRequest="40" />

                                        <!-- Description -->
                                        <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="3"
                                               Text="{Binding Description}"
                                               FontSize="14"
                                               LineBreakMode="WordWrap"
                                               IsVisible="{Binding Description, Converter={StaticResource StringToVisibilityConverter}}" />

                                        <!-- datum D -->
                                        <Label Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3"
                                               Text="{Binding DueDate, StringFormat='Förfaller: {0:dd/MM/yyyy}'}"
                                               FontSize="12"
                                               IsVisible="{Binding DueDate, Converter={StaticResource DateToVisibilityConverter}}" />

                                    </Grid>

                                </Frame>

                            </DataTemplate>
                        </CollectionView.ItemTemplate>

                    </CollectionView>
                </RefreshView>

            </StackLayout>
        </ScrollView>
    </ContentPage.Content>
</ContentPage>
