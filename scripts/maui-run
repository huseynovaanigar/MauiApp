#!/bin/zsh
set -euo pipefail

ROOT="$(cd "$(dirname "$0")/.." && pwd)"
PROJECT="$ROOT/Taskplanner/Taskplanner.csproj"

TFM="net9.0-ios"
RID="iossimulator-arm64"
CONFIG="Debug"

open -a Simulator >/dev/null 2>&1 || true
xcrun simctl bootstatus booted -b >/dev/null

dotnet build "$PROJECT" -c "$CONFIG" -f "$TFM" -p:RuntimeIdentifier="$RID"

APP="$ROOT/Taskplanner/bin/$CONFIG/$TFM/$RID/Taskplanner.app"

if [[ ! -d "$APP" ]]; then
  APP="$(find "$ROOT/Taskplanner/bin/$CONFIG" -type d -name "*.app" | head -n 1 || true)"
fi

if [[ -z "${APP:-}" || ! -d "$APP" ]]; then
  echo "Hittade ingen .app efter build."
  exit 1
fi

BUNDLE_ID="$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$APP/Info.plist")"

xcrun simctl uninstall booted "$BUNDLE_ID" >/dev/null 2>&1 || true
xcrun simctl install booted "$APP" >/dev/null
xcrun simctl launch booted "$BUNDLE_ID"

